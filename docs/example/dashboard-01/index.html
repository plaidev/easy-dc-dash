<!DOCTYPE html>
<html lang="ja">

  <head>
    <script type="text/javascript" src="../../../dist/bundle.browser.js"></script>
    <link rel="stylesheet" type="text/css" href="../../../dist/bundle.css" />
    <script type="text/javascript" src="https://jp.vuejs.org/js/vue.js"></script>

  </head>

  <body>

  <easy-dc-dataset
    csv='./dataset.csv'
    date-fields="session_end_date"
    int-fields="pv,bounce_cnt,session_cnt"
    date-format="%Y-%m-%dT%H:%M:%S.%LZ"
    labels="セグメント,PV,UU,セッション数,セッション毎平均PV数,セッション毎平均時間,離脱数,コンバーション数,最終PV時間"
  ></easy-dc-dataset>

  <easy-dc-dataset
    csv='../morley.csv'
    dataset="morley"
  ></easy-dc-dataset>

<div id="krt-dc-dashboard">
  <div class="container">

    <section class="row section-row is-16">
      <div class="col-md-4">
        <csv-download-button :file-name="defaultCsvFileName"></csv-download-button>
      </div>
      <div class="col-md-4">
        <csv-download-button dataset="morley"></csv-download-button>
      </div>
      <div class="col-md-4">
        <reset-all-button></reset-all-button>
      </div>
    </section>

    <section class="row section-row">
      <div class="col-md-4">
        <number-display
          title='PV'
          reduce="pv"
          unit-prefix='¥'
          unit-postfix='円'
        ></number-display>
      </div>
      <div class="col-md-4">
        <number-display
          title='ユニークユーザー数'
          reduce="uu"
        ></number-display>
      </div>
      <div class="col-md-4">
        <number-display
          reduce="session_cnt"
        ></number-display>
      </div>
    </section>

    <section class="row section-row">
      <div class="col-md-6">
        <date-volume-chart
          id="volume-chart"
          dimension='d.session_end_date'
          reduce='d.pv'
        ></date-volume-chart>
      </div>

      <div class="col-md-6">
        <week-row
        dimension='d.session_end_date'
        reduce='d.session_cnt'>
        </week-row>
      </div>
    </section>

    <section class="row section-row">
      <div class="col-md-3">
        <!-- Object segments -->
        <segment-pie
        dimension='d.segments'
        :segments="referrerSegments"
        reduce='d.pv'></segment-pie>
      </div>

      <div class="col-md-3">
        <!-- Array and label Object -->
        <segment-pie
        dimension='d.segments'
        :segments="deviceSegments"
        :labels="deviceSegmentLabels"
        reduce='d.pv'
        :show-label=false
        ></segment-pie>
      </div>

      <div class="col-md-3">
        <!-- segment CSV and Store.setLabels({...}) -->
        <segment-pie
        dimension='d.segments'
        segments='5890222d3601a6183b69f15a,5890222d3601a6183b69f15c,5890222d3601a6183b69f15e,5890222d3601a6183b69f160'
        reduce='d.pv'
        ></segment-pie>
      </div>

      <div class="col-md-3">
        <segment-pie
        dimension='d.name'
        segments="a,b,c,d,e,f"
        reduce='d.pv'
        :cap=3
        others-label='その他'
        ></segment-pie>
      </div>
    </section>

    <section class="row section-row">
      <div class="col-md-6">
        <list-row
        title='list-row'
        dimension='d.name'
        reduce='d.pv'
        :descending=true
        :cap=5>
        </list-row>
      </div>

      <div class="col-md-6">
        <list-row
        dataset="morley"
        title='morley'
        dimension='d.Expt'
        reduce='d.Run'
        ></list-row>
      </div>
    </section>

    <section class="row section-row">
      <div class="col-md-6">
        <ordinal-bar
        title='ordinal-bar'
        dimension='d.name'
        reduce='d.pv'
        x-axis-label='name'
        y-axis-label='pv'
        :show-x-axis-label='false'
        :show-y-axis-label='false'
        ordering="asc"
        color="tint"
        ></ordinal-bar>
      </div>

      <div class="col-md-6">
        <ordinal-bar
        title='ordinal-bar'
        dimension='d.name'
        reduce='d.pv'
        ordering="desc"
        color="tint"
        ></ordinal-bar>
      </div>
    </section>

    <section class="row section-row">
      <div class="col-md-12">
        <filter-stacked-bar
        title="filter stacked bar"
        dimension="d.name"
        extra-dimension="d.meta"
        reduce='d.pv'
        ></filter-stacked-bar>
      </div>
    </section>

    <section class="row section-row">
      <div class="col-md-12">
      </div>
    </section>

    <section class="row section-row">
      <div class="col-md-12">
        <stacked-lines
        dimension='d.session_end_date'
        scale="time.day"
        reduce='[d.pv, d.session_cnt, d.bounce_cnt]'
        labels='PV,セッション数,直帰率'
        ></stacked-lines>
      </div>
    </section>

    <section class="row section-row">
      <div class="col-md-12">
        <stack-and-rate
        scale='time.day'
        dimension='d.session_end_date'
        volume='volume-chart'
        reduce='[[d.bounce_cnt, d.pv - d.bounce_cnt], {count: d.session_cnt, value: d.bounce_cnt}]'
        labels='直帰,非直帰,直帰率'
        ></stack-and-rate>
      </div>
    </section>

    <section class="row section-row">
      <div class="col-md-6">
        <rate-line
        dimension='d.session_end_date'
        reduce='{count: d.session_cnt, value: d.bounce_cnt}'
        scale="time.day"
        ></rate-line>
      </div>

      <div class="col-md-6">
        <rate-line
        dimension='d.session_end_date'
        reduce='{count: d.session_cnt, value: d.bounce_cnt}'
        scale="time.day"
        :show-x-axis-label='false'
        :show-y-axis-label='false'
        ></rate-line>
      </div>
    </section>

    <section class="row section-row">
      <div class="col-md-12">
        <heat-map
        dimension="[d.name,d.meta]"
        reduce="d.pv"
        :labels="{name: '名前', meta: 'メタタグ', fuga: 'ふが', hoge: 'ほげ'}"
        :border-radius=0
        :render-text=true
        x-axis-label="x"
        y-axis-label="y"
        ></heat-map>
      </div>
    </section>

    <section class="row section-row">
      <div class="col-md-12">
        <series
        dimension="d.name"
        extra-dimension="d.meta"
        scale="ordinal"
        reduce="d.pv"
        ></series>
      </div>
    </section>

    <section class="row section-row">
      <div class="col-md-12">
        <bubble
        date-key='d.session_end_date'
        dimension='ymd'
        reduce="{x: d.pv, y: d.bounce_cnt, radius: {count: d.session_cnt, value: d.bounce_cnt}}"
        radius-format='%'
        :max-bubble-relative-size=0.1
        :show-label='false'
        ></bubble>
      </div>
    </section>

    <section class="row section-row">
      <div class="col-md-12">
        <data-table
        title='table'
        dimension="d.name"
        columns="{name: d.name, pv: d.pv, link: d.link, bounce_cnt: d.bounce_cnt, bounce_rate: {count: d.session_cnt, value: d.bounce_cnt}}"
        sort-by="name"
        order="descending"
        :representations="{link: 'linkFormat'}"
        :use-table-paging=true
        :offset=0
        :rows-per-page=5
        ></data-table>
      </div>
    </section>

    <section class="row section-row">
      <div class="col-md-12">
        <data-table
        dimension="d.session_end_date"
        columns="{date: d.session_end_date, pv: d.pv}"
        ></data-table>
      </div>
    </section>

  </div>
</div>

<script type="text/javascript">

EasyDC.Store.setLabels({
  bounce_rate: '離脱率',

  // repeat segment labels
  "5890222d3601a6183b69f15a": '初回来訪',
  "5890222d3601a6183b69f15c": '来訪2回',
  "5890222d3601a6183b69f15e": '来訪3回',
  "5890222d3601a6183b69f160": '来訪4回以上'
})


//-------------------
// メイン

const deviceSegments = {
  "5890222d3601a6183b69f151": 'SP',
  "5890222d3601a6183b69f14f": 'PC'
}

const params = {
  project_name: 'ProjectA',
  start_date: '20170920',
  end_date: '20170922'
}
const CSV_FILE_NAME = `Report ${params.project_name} (${params.start_date}〜${params.end_date})`;

const bindData = {
  deviceSegments: Object.keys(deviceSegments),
  deviceSegmentLabels: deviceSegments,
  referrerSegments: {
    "5890222d3601a6183b69f153": 'search',
    "58902caa7048639a5ba53b17": 'newspicks',
    "58902d517048639a5ba53b26": 'facebook',
    "58902e8c7048639a5ba53b3a": 'twitter'
  },
  defaultCsvFileName: CSV_FILE_NAME
}

for (let k in bindData) {
  EasyDC.Store.setBindData(k, bindData[k])
}

EasyDC.Store.registerRepresentation('linkFormat', (v, d, k) => {
  return v.split(', ').map((v) => {
    return `<a href="${v}" target="_blank">${v}</a>`
  }).join(', ')
})

EasyDC.run(true)

    </script>
  </body>
</html>