<!DOCTYPE html>
<html lang="ja">

  <head>
    <script type="text/javascript" src="../../../dist/bundle.browser.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/dc/2.0.0/dc.min.css" rel="stylesheet" type="text/css" />
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" type="text/css" />

    <script type="text/javascript" src="https://jp.vuejs.org/js/vue.js"></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>

  </head>

  <body>
  <easy-dc-dataset
    csv='./dataset.csv'
    date-fields="session_end_date"
    int-fields="pv,bounce_cnt,session_cnt"
    date-format="%Y-%m-%dT%H:%M:%S.%LZ"
    labels="セグメント,PV,UU,セッション数,セッション毎平均PV数,セッション毎平均時間,離脱数,コンバーション数,最終PV時間"
  ></easy-dc-dataset>

<div id="krt-dc-dashboard">
  <a onclick="EasyDC.Store.downloadCSV('data')">csv download</a>

  <div>
    <week-row dimension='d.session_end_date' reduce='d.session_cnt'></week-row>
    <segment-pie dimention='d.segments' :segments="referrerSegments" :labels="referrerSegmentLabels" reduce='d.pv'></segment-pie>
    <segment-pie dimension='d.segments' :segments="deviceSegments" :labels="deviceSegmentLabels" reduce='d.pv'></segment-pie>
    <segment-pie dimension='d.segments' :segments="repeatSegments" :labels="repeatSegmentLabels" reduce='d.pv'></segment-pie>
  </div>

  <div>
    <stack-and-rate scale='time' dimension='d.session_end_date' volume='date-volume-chart' reduce='[[d.bounce_cnt, d.pv - d.bounce_cnt], {count: d.session_cnt, value: d.bounce_cnt}]'></stack-and-rate>
    <volume-chart scale='time' dimension='d.session_end_date' reduce='d.pv' id='date-volume-chart'></volume-chart>
  </div>

  <div>
    <list-row dimension='d.name' reduce='d.pv' :width=768 :bar-height=30></list-row>
  </div>

  <div>
    <data-table
      dimension="d.name"
      columns="{name: d.name, pv: d.pv, bounce_cnt: d.bounce_cnt, bounce_rate: {count: d.session_cnt, value: d.bounce_cnt}}"
      sort-by="name"
      order="descending"
      :width=1000
      :height=1000
      :use-table-paging=true
      :offset=0
      :rows-per-page=5
      >
    </data-table>
  </div>
</div>

<script type="text/javascript">

//-------------------
// デザインをカスタマイズしたコンポーネント

const DateVolumeChart = {
  extends: EasyDC.Chart.Base,
  mounted: function() {
    this.chart
      .width(240*4)
      .height(60)
      .margins({
        top: 0,
        right: 50,
        bottom: 20,
        left: 40
      })
      .centerBar(true)
      .gap(1)
      .elasticY(true)
      .round(d3.time.day.round)
      //.round(time.week.round)
      .alwaysUseRounding(true)
      .xUnits(d3.time.days)
      .yAxis().ticks(0)

    this.chart.render()
  }
}


//-------------------
// セグメントのセット
// segment-pieで使う

const segmentSets = [
  {
    title: 'device',
    segments: {
      "5890222d3601a6183b69f151": 'SP',
      "5890222d3601a6183b69f14f": 'PC'
    }
  },
  {
    title: 'referrer',
    segments: {
      "5890222d3601a6183b69f153": 'search',
      "58902caa7048639a5ba53b17": 'newspicks',
      "58902d517048639a5ba53b26": 'facebook',
      "58902e8c7048639a5ba53b3a": 'twitter'
    },
  },
  {
    title: 'repeat',
    segments: {
      "5890222d3601a6183b69f15a": '初回来訪',
      "5890222d3601a6183b69f15c": '来訪2回',
      "5890222d3601a6183b69f15e": '来訪3回',
      "5890222d3601a6183b69f160": '来訪4回以上'
    },
  }
];


//--------------------

EasyDC.Store.setLabels({
  bounce_rate: '離脱率'
})


//-------------------
// メイン

function run(content) {

  // EasyDC.Store.registerData(content);

  const DashboardApp = new Vue({
    el: '#date-volume-chart',
    data: EasyDC.Store.state.binds,
    components: {
      'volume-chart': DateVolumeChart // 追加のコンポーネント
    }
  });
}

const bindData = {
  deviceSegments: Object.keys(segmentSets[0].segments),
  referrerSegments: Object.keys(segmentSets[1].segments),
  repeatSegments: Object.keys(segmentSets[2].segments),
  deviceSegmentLabels: segmentSets[0].segments,
  referrerSegmentLabels: segmentSets[1].segments,
  repeatSegmentLabels: segmentSets[2].segments
}

for (let k in bindData) {
  EasyDC.Store.setBindData(k, bindData[k])
}

EasyDC.run(true, run)

    </script>
  </body>
</html>