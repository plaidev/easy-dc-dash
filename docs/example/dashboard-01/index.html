<!DOCTYPE html>
<html lang="ja">

  <head>
    <script type="text/javascript" src="../../../dist/bundle.browser.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/dc/2.0.0/dc.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css">
    <script type="text/javascript" src="https://jp.vuejs.org/js/vue.js"></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>

  </head>

  <style>
    .buttons {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-around;
   }
    .buttons .download-csv-button a:not([href]):not([tabindex]) {
      color: #2AAB9F;
      cursor: pointer;
      font-weight: bold;
    }
    .buttons .download-csv-button .btn.btn-outline-primary {
      border-color: #2AAB9F;
    }
    .buttons .download-csv-button .btn.btn-outline-primary:hover {
      border-color: #2AAB9F;
      background-color: #fff;
      opacity: .8;
    }
  </style>

  <body>
  <easy-dc-dataset
    csv='./dataset.csv'
    date-fields="session_end_date"
    int-fields="pv,bounce_cnt,session_cnt"
    date-format="%Y-%m-%dT%H:%M:%S.%LZ"
    labels="セグメント,PV,UU,セッション数,セッション毎平均PV数,セッション毎平均時間,離脱数,コンバーション数,最終PV時間"
  ></easy-dc-dataset>

<div id="krt-dc-dashboard">
  <div class="buttons">
    <div class="download-csv-button">
      <a class="btn btn-outline-primary btn-lg" onclick="EasyDC.Store.downloadCSV('data')">csv download</a>
    </div>
    <reset-all-button></reset-all-button>
  </div>

  <div class="container" style="display: flex; flex-direction: row;">
    <week-row dimension='d.session_end_date' reduce='d.session_cnt'></week-row>
    <!-- Object segments -->
    <segment-pie
      dimention='d.segments'
      :segments="referrerSegments"
      reduce='d.pv'></segment-pie>

    <!-- Array and label Object -->
    <segment-pie
      dimension='d.segments'
      :segments="deviceSegments"
      :labels="deviceSegmentLabels"
      reduce='d.pv'
    ></segment-pie>

    <!-- segment CSV and Store.setLabels({...}) -->
    <segment-pie
      dimension='d.segments'
      segments='5890222d3601a6183b69f15a,5890222d3601a6183b69f15c,5890222d3601a6183b69f15e,5890222d3601a6183b69f160'
      reduce='d.pv'
    ></segment-pie>
  </div>

  <div class="container" style="display: flex; flex-direction: column;">
    <stack-and-rate scale='time' dimension='d.session_end_date' volume='date-volume-chart' reduce='[[d.bounce_cnt, d.pv - d.bounce_cnt], {count: d.session_cnt, value: d.bounce_cnt}]'></stack-and-rate>
    <volume-chart scale='time' dimension='d.session_end_date' reduce='d.pv' id='date-volume-chart'></volume-chart>
  </div>
  <div>
    <list-row
       dimension='d.name'
       reduce='d.pv'
       :descending=true
       :height=400
       :width=200
       :gap=10
       :rows=6
    ></list-row>
  </div>

  <div class="container" style="display: flex; flex-direction: row;">
    <ordinal-bar
      dimension='d.name'
      reduce='d.pv'
      :width=768
      :height=380
      x-axis-label='name'
      y-axis-label='pv'
    ></ordinal-bar>
    <stacked-bar
      dimension='d.name'
      reduce='[d.pv, d.session_cnt, d.bounce_cnt]'
      :labels="['PV', 'セッション数', '離脱数']"
      :width=768
      :height=380
      :legend-x=300
      x-axis-label='name'
      y-axis-label='pv + session_cnt + bounce_cnt'
    ></stacked-bar>
  </div>

  <div class="container" style="display: flex; flex-direction: row;">
    <!-- dimensions="[d.name, d.meta]"
            -> x-axis(name), y-axis(meta)
    -->
    <filter-stacked-bar
      dimensions="[d.name, d.meta]"
      reduce='d.pv'
      :width=400
      :height=400
      :legend-x=350
      :legend-y=0
    ></filter-stacked-bar>
    <segment-pie
      dimension='d.name'
      segments="a,b,c,d,e,f"
      reduce='d.pv'></segment-pie>
  </div>

  <div class="container">
    <heat-map
      date-key='d.session_end_date'
      dimensions="[year, month]"
      reduce="d.pv"
      x-axis-format="年"
      y-axis-format="月"
      :y-border-radius=3
    ></heat-map>
  </div>

  <div class="container">
    <data-table
      dimension="d.name"
      columns="{name: d.name, pv: d.pv, bounce_cnt: d.bounce_cnt, bounce_rate: {count: d.session_cnt, value: d.bounce_cnt}}"
      sort-by="name"
      order="descending"
      :width=1000
      :height=1000
      :use-table-paging=true
      :offset=0
      :rows-per-page=5
      >
    </data-table>
  </div>
</div>

<script type="text/javascript">

//-------------------
// デザインをカスタマイズしたコンポーネント

const DateVolumeChart = {
  extends: EasyDC.Chart.Base,
  mounted: function() {
    this.chart
      .width(240*4)
      .height(60)
      .margins({
        top: 0,
        right: 50,
        bottom: 20,
        left: 40
      })
      .centerBar(true)
      .gap(1)
      .elasticY(true)
      .round(d3.time.day.round)
      //.round(time.week.round)
      .alwaysUseRounding(true)
      .xUnits(d3.time.days)
      .yAxis().ticks(0)

    this.chart.render()
  }
}


//--------------------

EasyDC.Store.setLabels({
  bounce_rate: '離脱率',

  // repeat segment labels
  "5890222d3601a6183b69f15a": '初回来訪',
  "5890222d3601a6183b69f15c": '来訪2回',
  "5890222d3601a6183b69f15e": '来訪3回',
  "5890222d3601a6183b69f160": '来訪4回以上'
})


//-------------------
// メイン

function run(content) {

  // EasyDC.Store.registerData(content);

  const DashboardApp = new Vue({
    el: '#date-volume-chart',
    data: EasyDC.Store.state.binds,
    components: {
      'volume-chart': DateVolumeChart // 追加のコンポーネント
    }
  });
}

const deviceSegments = {
  "5890222d3601a6183b69f151": 'SP',
  "5890222d3601a6183b69f14f": 'PC'
}

const bindData = {
  deviceSegments: Object.keys(deviceSegments),
  deviceSegmentLabels: deviceSegments,
  referrerSegments: {
    "5890222d3601a6183b69f153": 'search',
    "58902caa7048639a5ba53b17": 'newspicks',
    "58902d517048639a5ba53b26": 'facebook',
    "58902e8c7048639a5ba53b3a": 'twitter'
  }
}

for (let k in bindData) {
  EasyDC.Store.setBindData(k, bindData[k])
}

EasyDC.run(true, run)

    </script>
  </body>
</html>