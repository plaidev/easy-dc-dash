<!DOCTYPE html>
<html lang="ja">

  <head>
    <script type="text/javascript" src="https://jp.vuejs.org/js/vue.js"></script>
    <script type="text/javascript" src="../../../dist/bundle.browser.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/dc/2.0.0/dc.min.css" rel="stylesheet" type="text/css" />

    <script src="https://d3js.org/d3.v3.min.js"></script>

  </head>

  <body>

<div id="krt-dc-dashboard">
  <div>
    <week-row dimension='d.session_end_date' reduce='d.session_cnt'></week-row>
    <segment-pie dimention='d.segments' :segments="referrerSegments" :labels="referrerSegmentLabels" reduce='d.pv'></segment-pie>
    <segment-pie dimension='d.segments' :segments="deviceSegments" :labels="deviceSegmentLabels" reduce='d.pv'></segment-pie>
    <segment-pie dimension='d.segments' :segments="repeatSegments" :labels="repeatSegmentLabels" reduce='d.pv'></segment-pie>
  </div>

  <div>
    <stack-and-rate scale='time' dimension='d.session_end_date' volume='date-volume-chart' reduce='[[d.bounce_cnt, d.pv - d.bounce_cnt], {count: d.session_cnt, value: d.bounce_cnt}]'></stack-and-rate>
    <volume-chart scale='time' dimension='d.session_end_date' reduce='d.pv' id='date-volume-chart'></volume-chart>
  </div>
</div>

<script type="text/javascript">

//-------------------
// デザインをカスタマイズしたコンポーネント

const DateVolumeChart = {
  extends: EasyDC.Chart.Base,
  mounted: function() {
    this.chart
      .width(240*4)
      .height(60)
      .margins({
        top: 0,
        right: 50,
        bottom: 20,
        left: 40
      })
      .centerBar(true)
      .gap(1)
      .elasticY(true)
      .round(d3.time.day.round)
      //.round(time.week.round)
      .alwaysUseRounding(true)
      .xUnits(d3.time.days)
      .yAxis().ticks(0)

    this.chart.render()
  }
}


//-------------------
// セグメントのセット
// segment-pieで使う

const segmentSets = [
  {
    title: 'device',
    segments: {
      "5890222d3601a6183b69f151": 'SP',
      "5890222d3601a6183b69f14f": 'PC'
    }
  },
  {
    title: 'referrer',
    segments: {
      "5890222d3601a6183b69f153": 'search',
      "58902caa7048639a5ba53b17": 'newspicks',
      "58902d517048639a5ba53b26": 'facebook',
      "58902e8c7048639a5ba53b3a": 'twitter'
    },
  },
  {
    title: 'repeat',
    segments: {
      "5890222d3601a6183b69f15a": '初回来訪',
      "5890222d3601a6183b69f15c": '来訪2回',
      "5890222d3601a6183b69f15e": '来訪3回',
      "5890222d3601a6183b69f160": '来訪4回以上'
    },
  }
];


//-------------------
// メイン

function run(content) {

  EasyDC.Store.registerData(content);

  const bindData = {
    deviceSegments: Object.keys(segmentSets[0].segments),
    referrerSegments: Object.keys(segmentSets[1].segments),
    repeatSegments: Object.keys(segmentSets[2].segments),
    deviceSegmentLabels: segmentSets[0].segments,
    referrerSegmentLabels: segmentSets[1].segments,
    repeatSegmentLabels: segmentSets[2].segments
  }

  for (let k in bindData) {
    EasyDC.Store.setBindData(k, bindData[k])
  }

  const DashboardApp = new Vue({
    el: '#krt-dc-dashboard',
    data: EasyDC.Store.state.binds,
    components: {
      'volume-chart': DateVolumeChart // 追加のコンポーネント
    }
  });
}



//-------------------
// データ読み込み
d3.csv(
  './dataset.csv',
  function(d) {

    (['pv', 'uu', 'bounce_cnt', 'session_cnt', 'cv_cnt']).forEach((field) => {
      d[field] = parseInt(d[field])
    });

    (['avg_session_view_count', 'avg_session_spend_time']).forEach((field) => {
      d[field] = parseFloat(d[field])
    });

    var isoFormat = d3.time.format.utc('%Y-%m-%dT%H:%M:%S.%LZ');
    (['session_end_date']).forEach((field) => {
      d[field] = isoFormat.parse(d[field])
    })
    return d
  },
  run);

    </script>
  </body>
</html>