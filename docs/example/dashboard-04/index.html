<!DOCTYPE html>
<html lang="ja">

  <head>
    <script type="text/javascript" src="../../../dist/bundle.browser.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/dc/2.0.0/dc.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css">
    <script type="text/javascript" src="https://jp.vuejs.org/js/vue.js"></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>

  </head>

  <style>
    .buttons {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-around;
   }
    .buttons .download-csv-button a:not([href]):not([tabindex]) {
      color: #2AAB9F;
      cursor: pointer;
      font-weight: bold;
    }
    .buttons .download-csv-button .btn.btn-outline-primary {
      border-color: #2AAB9F;
    }
    .buttons .download-csv-button .btn.btn-outline-primary:hover {
      border-color: #2AAB9F;
      background-color: #fff;
      opacity: .8;
    }
  </style>

  <body>
  <easy-dc-dataset
    csv='./dataset.csv'
    date-fields="date"
    date-format="%Y-%m-%dT00:00:00.000Z"
    int-fields="talk_count,send_count,reply_count"
    labels=""
  ></easy-dc-dataset>

<div id="krt-dc-dashboard">
  <div class="buttons">
    <div class="download-csv-button">
      <a class="btn btn-outline-primary btn-lg" onclick="EasyDC.Store.downloadCSV('data')">csv download</a>
    </div>
    <reset-all-button></reset-all-button>
  </div>

  <div class="container" style="display: flex; flex-direction: row;">
    <week-row dimension='d.date' reduce='d.send_count'></week-row>
  </div>
  <div class="container" style="display: flex; flex-direction:row; align-items:center; justify-content:space-around">
    <number-display
      reduce="d.talk_count"
    ></number-display>
    <number-display
      reduce="d.reply_count"
    ></number-display>
    <number-display
      reduce="d.send_count"
    ></number-display>
  </div>

  <div class="container" style="display: flex; flex-direction: column;">
    <stack-and-rate scale='time' dimension='d.date' volume='date-volume-chart' reduce='[[d.talk_count, d.send_count, d.reply_count], {count: d.talk_count, value: d.send_count}]' :labels="['a','b','c','d']"></stack-and-rate>
    <volume-chart scale='time' dimension='d.date' reduce='d.talk_count' id='date-volume-chart'></volume-chart>
  </div>

  <div>
    <list-row
      dimension='d.name'
      reduce='d.talk_count'
      :descending=true
      :height=600
      :width=200
      :gap=10
      :rows=20
    ></list-row>
  </div>

  <div class="container" style="display: flex; flex-direction: row;">
    <ordinal-bar
      dimension='d.name'
      reduce='d.talk_count'
      :width=300
      :height=250
    ></ordinal-bar>
    <stacked-bar
      dimension='d.name'
      reduce='[d.talk_count, d.send_count, d.reply_count]'
      :labels="['送返信', '送信', '返信']"
      :width=300
      :height=250
      :legend-x=250
    ></stacked-bar>
  </div>

  <div class="container" style="display: flex; flex-direction: row;">
    <!-- dimensions="[d.name, d.meta]"
            -> x-axis(name), y-axis(meta)
    -->
    <filter-stacked-bar
      dimension="[d.name, d.app_name]"
      reduce='d.talk_count'
      :width=300
      :height=250
      :legend-x=250
      :legend-y=0
    ></filter-stacked-bar>
  </div>

  <div class="container">
    <heat-map
      date-key='d.date'
      dimension="[year, month]"
      reduce="d.talk_count"
      x-axis-format="年"
      y-axis-format="月"
      :y-border-radius=3
    ></heat-map>
    <series
      date-key="d.date"
      dimension="[year, month]"
      reduce="d.send_count"
    ></series>
    <bubble
      dimension="d.date"
      time-scale="month"
      time-format="%Y-%m"
      reduce="{x: d.talk_count, y: d.reply_count, radius: d.send_count}"
      :width=990
      :height=250
      :max-bubble-relative-size=0.1
    ></bubble>
  </div>

  <div class="container">
    <data-table
      dimension="d.name"
      columns="{name: d.name, talk_count: d.talk_count, send_count: d.send_count, reply_count: d.reply_count}"
      sort-by="name"
      order="descending"
      :width=1000
      :height=1000
      :use-table-paging=true
      :offset=0
      :rows-per-page=5
      >
    </data-table>
  </div>
</div>

<script type="text/javascript">

//-------------------
// デザインをカスタマイズしたコンポーネント

const _ymdFormat = d3.time.format('%Y-%m-%d')

const DateVolumeChart = {
  extends: EasyDC.Chart.Base,
  mounted: function() {
    this.chart
      .width(240*4)
      .height(60)
      .margins({
        top: 0,
        right: 50,
        bottom: 20,
        left: 40
      })
      .centerBar(true)
      .gap(1)
      .elasticY(true)
      .round(d3.time.day.round)
      //.round(time.week.round)
      .alwaysUseRounding(true)
      .xUnits(d3.time.days)
      .yAxis().ticks(0)

    this.chart.filterPrinter(filters => {
      return filters.map(filter => {
        return filter.map(f => {
          return `[${_ymdFormat(f)}]`
        }).join(',').replace(/\,/, ' ~ ')
      });
    });
    this.chart.render()
  }
}


// メイン

function run(content) {

  // EasyDC.Store.registerData(content);

  const DashboardApp = new Vue({
    el: '#date-volume-chart',
    data: EasyDC.Store.state.binds,
    components: {
      'volume-chart': DateVolumeChart // 追加のコンポーネント
    }
  });
}

EasyDC.run(true, run)

    </script>
  </body>
</html>